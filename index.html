<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Standalone Demand Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        vazir: ['Vazirmatn', 'sans-serif'],
                    },
                     keyframes: {
                        'toast-in': {
                          'from': { transform: 'translateX(100%)', opacity: '0' },
                          'to': { transform: 'translateX(0)', opacity: '1' },
                        },
                     },
                     animation: {
                        'toast-in': 'toast-in 0.5s ease-out forwards',
                     }
                },
            },
        }
    </script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .dark body {
            background-color: #111827; /* dark:bg-gray-900 */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal-content {
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5; /* indigo-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 3rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==================================================
        // Supabase Client Setup
        // ==================================================
        const { createClient } = supabase;

        // Note: The Supabase variables __supabase_url and __supabase_anon_key are expected to be available globally in the execution environment.
        const supabaseUrl = typeof __supabase_url !== 'undefined' ? __supabase_url : 'https://wehyjatotbzxargnxasg.supabase.co';
        const supabaseKey = typeof __supabase_anon_key !== 'undefined' ? __supabase_anon_key : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlaHlqYXRvdGJ6eGFyZ254YXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTIwMjEsImV4cCI6MjA2NzQ4ODAyMX0.2R448DuEBlTrNvaYXiYZ8D5M7MJNv7n1qmIDHQBNFiY';

        const supabaseClient = createClient(supabaseUrl, supabaseKey, {
            global: {
                fetch: (url, options) => {
                    return window.fetch(url, options);
                }
            }
        });


        // ==================================================
        // Helper Functions & UI Components
        // ==================================================
        const formatCurrency = (value) => {
            if (value === null || typeof value === 'undefined' || isNaN(value)) return '-';
            return `${Number(value).toLocaleString('fa-IR')} تومان`;
        };
        
        const formatDateTime = (dateString, includeTime = true) => {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date)) return '-';
                if (!window.jalaali || !window.jalaali.toJalaali) { 
                    // Fallback to standard date if jalaali-js is unavailable
                    return date.toLocaleString('en-CA');
                }
                const jDate = window.jalaali.toJalaali(date);
                const year = jDate.jy;
                const month = String(jDate.jm).padStart(2, '0');
                const day = String(jDate.jd).padStart(2, '0');
                if (!includeTime) return `${year}/${month}/${day}`;
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            } catch (e) {
                console.error("Error formatting datetime:", e);
                return dateString;
            }
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            React.useEffect(() => {
                document.body.style.overflow = 'hidden';
                return () => { document.body.style.overflow = 'unset'; };
            }, [isOpen]);
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 pb-3 border-b border-gray-200 dark:border-gray-600">
                            <h2 className="text-xl font-bold">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-800 dark:hover:text-white text-2xl">&times;</button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={title}>
                    <p className="text-gray-600 dark:text-gray-300 mb-6">{message}</p>
                    <div className="flex flex-col sm:flex-row justify-end gap-3">
                        <button type="button" onClick={onClose} className="w-full sm:w-auto bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-700 text-gray-800 dark:text-white font-bold py-2 px-4 rounded-lg">لغو</button>
                        <button type="button" onClick={onConfirm} className="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">تایید</button>
                    </div>
                </Modal>
            );
        };
        
        const SearchableSelect = ({ options, value, onChange, placeholder, disabled = false }) => {
            const [searchTerm, setSearchTerm] = React.useState('');
            const [isOpen, setIsOpen] = React.useState(false);
            const wrapperRef = React.useRef(null);

            const selectedOption = React.useMemo(() => options.find(opt => opt.id === value), [options, value]);

            const filteredOptions = React.useMemo(() => {
                if (!searchTerm) return options;
                const lowerSearchTerm = searchTerm.toLowerCase();
                return options.filter(opt =>
                    opt.title.toLowerCase().includes(lowerSearchTerm)
                );
            }, [options, searchTerm]);

            React.useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                        setSearchTerm('');
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const handleSelect = (option) => {
                onChange(option.id);
                setSearchTerm('');
                setIsOpen(false);
            };

            return (
                <div className="relative" ref={wrapperRef}>
                    <input
                        type="text"
                        placeholder={selectedOption ? selectedOption.title : placeholder}
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                        onFocus={() => setIsOpen(true)}
                        disabled={disabled}
                        className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    />
                    {isOpen && !disabled && (
                        <div className="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map(option => (
                                    <div
                                        key={option.id}
                                        onClick={() => handleSelect(option)}
                                        className="p-2 hover:bg-indigo-100 dark:hover:bg-indigo-800 cursor-pointer"
                                    >
                                        {option.title}
                                    </div>
                                ))
                            ) : (
                                <div className="p-2 text-gray-500">موردی یافت نشد.</div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const DemandFormModal = ({ isOpen, onClose, onSave, customers, products, defaultStatusId }) => {
            const [customerId, setCustomerId] = React.useState('');
            const [deadline, setDeadline] = React.useState('');
            const [isEmergency, setIsEmergency] = React.useState(false);
            const [items, setItems] = React.useState([{ productid: '', quantity: '', demand_admin_note: '', supply_admin_note: '', key: crypto.randomUUID() }]);
            const [error, setError] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [supplierPrices, setSupplierPrices] = React.useState({});

            const [customerLocations, setCustomerLocations] = React.useState([]);
            const [locationId, setLocationId] = React.useState('');
            const [isFetchingLocations, setIsFetchingLocations] = React.useState(false);

            React.useEffect(() => {
                const fetchLocations = async () => {
                    if (!customerId) {
                        setCustomerLocations([]);
                        setLocationId('');
                        return;
                    }
                    setIsFetchingLocations(true);
                    const { data, error } = await supabaseClient
                        .from('userlocation')
                        .select('location(*, city(*, province(*)))')
                        .eq('userid', customerId);
                    
                    if (error) {
                        console.error("Error fetching customer locations:", error);
                        setError("خطا در دریافت آدرس‌های مشتری.");
                    } else {
                        setCustomerLocations(data.map(ul => ul.location).filter(loc => loc)); // Filter out potential null locations
                        if (data.length === 1 && data[0].location) {
                            setLocationId(data[0].location.id);
                        } else {
                            setLocationId('');
                        }
                    }
                    setIsFetchingLocations(false);
                };

                fetchLocations();
            }, [customerId]);

            const handleAddItem = () => {
                setItems([...items, { productid: '', quantity: '', demand_admin_note: '', supply_admin_note: '', key: crypto.randomUUID() }]);
            };

            const handleItemChange = async (index, field, value) => {
                const newItems = [...items];
                newItems[index][field] = value;
                setItems(newItems);

                if (field === 'productid' && value) {
                    // Fetch supplier prices for the selected product
                    const { data, error } = await supabaseClient
                        .from('supplierstock')
                        .select('unitprice, profiles:supplieruserid (fullname)')
                        .eq('productid', value);
                    
                    if (error) {
                        console.error("Error fetching supplier prices:", error);
                    } else {
                        setSupplierPrices(prev => ({...prev, [value]: data}));
                    }
                }
            };

            const handleRemoveItem = (index) => {
                setItems(items.filter((_, i) => i !== index));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!customerId || items.length === 0 || items.some(i => !i.productid || !i.quantity)) {
                    setError('لطفا مشتری را انتخاب کرده و حداقل یک کالا با تعداد مشخص اضافه کنید.');
                    return;
                }
                if (customerLocations.length > 0 && !locationId) {
                    setError('لطفا آدرس تحویل مشتری را انتخاب کنید.');
                    return;
                }
                
                setIsLoading(true);
                setError('');

                try {
                    // Step 1: Create the demand header
                    const { data: demandData, error: demandError } = await supabaseClient
                        .from('demand')
                        .insert({
                            customeruserid: customerId,
                            deadlinedate: deadline || null,
                            locationid: locationId || null,
                            is_emergency: isEmergency,
                        })
                        .select()
                        .single();

                    if (demandError) throw demandError;

                    // Step 2: Prepare and insert the demand items with default status
                    const demandItems = items.map(item => ({
                        demandid: demandData.id,
                        productid: item.productid,
                        quantity: Number(item.quantity),
                        demand_admin_note: item.demand_admin_note,
                        supply_admin_note: item.supply_admin_note,
                        demandstatusid: defaultStatusId 
                    }));

                    const { data: insertedItems, error: itemsError } = await supabaseClient
                        .from('demand_item')
                        .insert(demandItems)
                        .select();

                    if (itemsError) throw itemsError;

                    // Step 3: Log the initial status for each newly created item
                    const logsToInsert = insertedItems.map(item => ({
                        demand_item_id: item.id,
                        demandstatusid: defaultStatusId
                    }));

                    if (logsToInsert.length > 0) {
                        const { error: logError } = await supabaseClient
                            .from('demandstatuslog')
                            .insert(logsToInsert);

                        if (logError) {
                            console.error("Error logging initial status:", logError);
                        }
                    }

                    onSave();
                } catch (err) {
                    console.error("Error creating demand:", err);
                    setError(`خطا در ثبت تقاضا: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };
            
            const customerOptions = customers.map(c => {
                const displayTitle = `${c.fullname} (${c.mobile || 'بدون شماره'})`;
                return { id: c.id, title: displayTitle };
            });
            
            const productOptions = products.map(p => {
                const telegramCodeProp = p.productproperty?.find(
                    prop => prop.propertykey?.title?.toLowerCase().includes('تلگرام')
                );
                const telegramCode = telegramCodeProp ? telegramCodeProp.value : '';
                const displayTitle = `${telegramCode ? `[${telegramCode}] ` : ''}${p.brand ? p.brand.title + ' ' : ''}${p.title}`;
                return { id: p.id, title: displayTitle };
            });

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="ثبت تقاضای جدید">
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">مشتری</label>
                                <SearchableSelect options={customerOptions} value={customerId} onChange={setCustomerId} placeholder="جستجوی نام یا شماره مشتری..." />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">مهلت تحویل (اختیاری)</label>
                                <input type="date" value={deadline} onChange={e => setDeadline(e.target.value)} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg" />
                            </div>
                        </div>
                        
                        <div className="flex items-center">
                            <input type="checkbox" id="is_emergency" checked={isEmergency} onChange={(e) => setIsEmergency(e.target.checked)} className="ml-2 h-4 w-4 rounded text-red-600 border-red-300 focus:ring-red-500" />
                            <label htmlFor="is_emergency" className="text-sm font-medium">تقاضای فوری</label>
                        </div>

                        {isFetchingLocations && <p className="text-sm text-gray-500">در حال بارگذاری آدرس‌ها...</p>}
                        {customerId && !isFetchingLocations && customerLocations.length > 0 && (
                             <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">آدرس تحویل</label>
                                <select value={locationId} onChange={e => setLocationId(e.target.value)} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg" required>
                                    <option value="" disabled>یک آدرس را انتخاب کنید...</option>
                                    {customerLocations.map(loc => {
                                        const fullAddress = `${loc.city?.province?.title || ''}, ${loc.city?.title || ''}, ${loc.address || ''}`;
                                        return <option key={loc.id} value={loc.id}>{fullAddress}</option>
                                    })}
                                </select>
                            </div>
                        )}
                        {customerId && !isFetchingLocations && customerLocations.length === 0 && (
                            <p className="text-sm text-yellow-500 bg-yellow-100 dark:bg-yellow-900/50 p-2 rounded-md">
                                این مشتری آدرسی ثبت نکرده است. تقاضا بدون آدرس ثبت خواهد شد.
                            </p>
                        )}

                        <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
                            <h3 className="text-lg font-semibold mb-2">اقلام درخواستی</h3>
                            <div className="space-y-3">
                                {items.map((item, index) => {
                                    const prices = supplierPrices[item.productid] || [];
                                    const selectedProduct = products.find(p => p.id === item.productid);
                                    let productProperties = [];
                                    if (selectedProduct && selectedProduct.productproperty) {
                                        productProperties = selectedProduct.productproperty
                                            .filter(prop => prop.propertykey && prop.value)
                                            .map(prop => ({ title: prop.propertykey.title, value: prop.value }));
                                    }
                                    return (
                                        <div key={item.key} className="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-700">
                                            <div className="grid grid-cols-1 md:grid-cols-5 items-end gap-x-4 gap-y-2">
                                                <div className="md:col-span-3">
                                                    <label className="text-xs text-gray-500 dark:text-gray-400">محصول</label>
                                                    <SearchableSelect options={productOptions} value={item.productid} onChange={(id) => handleItemChange(index, 'productid', id)} placeholder="جستجوی محصول با نام یا کد..." />
                                                </div>
                                                <div className="md:col-span-1">
                                                    <label className="text-xs text-gray-500 dark:text-gray-400">تعداد</label>
                                                    <input type="number" value={item.quantity} onChange={(e) => handleItemChange(index, 'quantity', e.target.value)} className="w-full bg-white dark:bg-gray-600 p-2 rounded-lg" placeholder="تعداد" min="1" required />
                                                </div>
                                                <div className="flex justify-end"><button type="button" onClick={() => handleRemoveItem(index)} className="text-red-500 hover:text-red-700 p-2">✕</button></div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                                <textarea value={item.demand_admin_note} onChange={(e) => handleItemChange(index, 'demand_admin_note', e.target.value)} placeholder="یادداشت مدیر تقاضا..." className="w-full text-sm bg-white dark:bg-gray-600 p-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500" rows="2"></textarea>
                                                <textarea value={item.supply_admin_note} onChange={(e) => handleItemChange(index, 'supply_admin_note', e.target.value)} placeholder="یادداشت مدیر تامین..." className="w-full text-sm bg-white dark:bg-gray-600 p-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500" rows="2"></textarea>
                                            </div>
                                            {prices.length > 0 && (
                                                <div className="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                                                    <h4 className="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">قیمت‌های تامین‌کنندگان:</h4>
                                                    <div className="flex flex-wrap gap-2">
                                                        {prices.map((price, idx) => ( <div key={idx} className="bg-gray-200 dark:bg-gray-600 text-xs px-2 py-1 rounded-full"><span className="font-semibold">{price.profiles.fullname}:</span> {formatCurrency(price.unitprice)}</div> ))}
                                                    </div>
                                                </div>
                                            )}
                                            {productProperties.length > 0 && (
                                                <div className="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                                                    <h4 className="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">ویژگی‌های محصول:</h4>
                                                    <div className="flex flex-wrap gap-2">
                                                        {productProperties.map(prop => ( <div key={prop.title} className="bg-gray-200 dark:bg-gray-600 text-xs px-2 py-1 rounded-full"><span className="font-semibold">{prop.title}:</span> {prop.value}</div> ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        )
                                    })}
                            </div>
                            <button type="button" onClick={handleAddItem} className="mt-4 w-full text-center py-2 px-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition font-semibold">+ افزودن کالا</button>
                        </div>
                        
                        {error && <p className="text-red-500 text-sm">{error}</p>}

                        <div className="flex justify-end gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <button type="button" onClick={onClose} className="bg-gray-200 dark:bg-gray-600 py-2 px-5 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-700 transition">بازگشت</button>
                            <button type="submit" disabled={isLoading} className="bg-indigo-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-indigo-700 transition disabled:bg-indigo-400">{isLoading ? 'در حال ثبت...' : 'ثبت تقاضا'}</button>
                        </div>
                    </form>
                </Modal>
            );
        };
        
        const EditDemandItemModal = ({ isOpen, onClose, onSave, itemToEdit, demand, demandStatuses, groupedStatuses }) => {
            const [formData, setFormData] = React.useState({ quantity: '', demand_admin_note: '', supply_admin_note: '', approved_supply_price: '', approved_supply_quantity: '' });
            const [statusId, setStatusId] = React.useState('');
            const [cancellationReason, setCancellationReason] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [isEmergency, setIsEmergency] = React.useState(false);

            const isCancelled = React.useMemo(() => {
                if (!statusId) return false;
                const selectedStatus = demandStatuses.find(s => s.id === statusId);
                return selectedStatus?.main_status === 'Cancelled';
            }, [statusId, demandStatuses]);

            const cancellationReasons = ["قیمت بالا", "عدم موجودی", "عدم پاسخگویی", "به تعویق افتاده", "خرید از رقبا", "درخواست تعداد پایین", "درخواست تنوع", "هزینه ارسال بالا", "عدم اعتماد", "فاکتور بی‌پاسخ", "خرید چکی"];

            React.useEffect(() => {
                if (itemToEdit && demand) {
                    setFormData({
                        quantity: itemToEdit.quantity || '',
                        demand_admin_note: itemToEdit.demand_admin_note || '',
                        supply_admin_note: itemToEdit.supply_admin_note || '',
                        approved_supply_price: itemToEdit.approved_supply_price || '',
                        approved_supply_quantity: itemToEdit.approved_supply_quantity || ''
                    });
                    setStatusId(itemToEdit.demandstatusid || '');
                    setIsEmergency(demand.is_emergency || false);
                    setCancellationReason('');
                    if (itemToEdit.demand_admin_note?.startsWith('(دلیل لغو:')) {
                        const match = itemToEdit.demand_admin_note.match(/\(دلیل لغو: (.*?)\)/);
                        if (match && match[1]) {
                             setCancellationReason(match[1]);
                             setFormData(prev => ({...prev, demand_admin_note: itemToEdit.demand_admin_note.replace(match[0], '').trim() }));
                        }
                    }
                }
            }, [itemToEdit, demand]);
            
            if (!itemToEdit || !demand) return null;

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.quantity || Number(formData.quantity) <= 0) {
                    setError('تعداد درخواستی باید یک عدد مثبت باشد.');
                    return;
                }
                if (isCancelled && !cancellationReason) {
                    setError('لطفا دلیل لغو را مشخص کنید.');
                    return;
                }
                setIsLoading(true);
                setError('');
                
                try {
                    let final_demand_note = formData.demand_admin_note;
                    if (isCancelled) {
                        final_demand_note = `(دلیل لغو: ${cancellationReason}) ${formData.demand_admin_note}`.trim();
                    }

                    const approved_supply_price = formData.approved_supply_price === '' ? null : Number(formData.approved_supply_price);
                    const approved_supply_quantity = formData.approved_supply_quantity === '' ? null : Number(formData.approved_supply_quantity);

                    const updatedFields = {
                        quantity: Number(formData.quantity),
                        demand_admin_note: final_demand_note,
                        supply_admin_note: formData.supply_admin_note,
                        approved_supply_price: approved_supply_price,
                        approved_supply_quantity: approved_supply_quantity,
                        demandstatusid: statusId
                    };
                    
                    const { error: updateError } = await supabaseClient.from('demand_item').update(updatedFields).eq('id', itemToEdit.id);
                    if (updateError) throw updateError;
                    
                    if (itemToEdit.demandstatusid !== statusId) {
                         const newStatus = demandStatuses.find(s => s.id === statusId);
                         await supabaseClient.from('demandstatuslog').insert({ demand_item_id: itemToEdit.id, demandstatusid: statusId });
                         await supabaseClient.from('demand_item_log').insert({ demand_item_id: itemToEdit.id, change_description: `وضعیت به ${newStatus?.title_farsi} تغییر کرد.` });
                    }
                    
                    if (demand.is_emergency !== isEmergency) {
                        const { error: demandUpdateError } = await supabaseClient
                            .from('demand')
                            .update({ is_emergency: isEmergency })
                            .eq('id', demand.id);
                        if (demandUpdateError) throw demandUpdateError;
                    }

                    onSave();
                } catch(err) {
                    console.error("Error updating item:", err);
                    setError(`خطا در به‌روزرسانی: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`ویرایش آیتم: ${itemToEdit.product.title}`}>
                    <div className="p-4 mb-4 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg grid grid-cols-2 md:grid-cols-3 gap-4 text-sm text-gray-800 dark:text-gray-200">
                        <div><span className="font-semibold text-gray-600 dark:text-gray-400">مشتری:</span> {demand.profiles.fullname}</div>
                        <div><span className="font-semibold text-gray-600 dark:text-gray-400">شهر:</span> {demand.location?.city?.title || '-'}</div>
                        <div><span className="font-semibold text-gray-600 dark:text-gray-400">برند:</span> {itemToEdit.product.brand?.title || '-'}</div>
                    </div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="flex items-center">
                            <input type="checkbox" id="is_emergency_edit_item" checked={isEmergency} onChange={(e) => setIsEmergency(e.target.checked)} className="ml-2 h-4 w-4 rounded text-red-600 border-red-300 focus:ring-red-500" />
                            <label htmlFor="is_emergency_edit_item" className="text-sm font-medium">تقاضای فوری</label>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">وضعیت آیتم</label>
                                <select value={statusId} onChange={e => setStatusId(Number(e.target.value))} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg">
                                    {Object.entries(groupedStatuses).map(([mainStatus, statuses]) => (
                                        <optgroup key={mainStatus} label={mainStatus}>
                                            {statuses.map(status => ( <option key={status.id} value={status.id}>{status.title_farsi}</option> ))}
                                        </optgroup>
                                    ))}
                                </select>
                            </div>
                            {isCancelled && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">دلیل لغو</label>
                                    <select value={cancellationReason} onChange={e => setCancellationReason(e.target.value)} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg" required>
                                        <option value="" disabled>انتخاب دلیل...</option>
                                        {cancellationReasons.map(reason => <option key={reason} value={reason}>{reason}</option>)}
                                    </select>
                                </div>
                            )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                             <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تعداد درخواستی</label>
                                <input type="number" name="quantity" value={formData.quantity} onChange={handleChange} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg" min="1" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تعداد  تامین شده</label>
                                <input type="number" name="approved_supply_quantity" value={formData.approved_supply_quantity} onChange={handleChange} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg" min="0" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">قیمت  تامین شده (تومان)</label>
                                <input type="number" name="approved_supply_price" value={formData.approved_supply_price} onChange={handleChange} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg" min="0" />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">یادداشت مدیر تقاضا</label>
                            <textarea name="demand_admin_note" value={formData.demand_admin_note} onChange={handleChange} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg" rows="3"></textarea>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">یادداشت مدیر تامین</label>
                            <textarea name="supply_admin_note" value={formData.supply_admin_note} onChange={handleChange} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg" rows="3"></textarea>
                        </div>
                        {error && <p className="text-red-500 text-sm">{error}</p>}
                        <div className="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-600">
                             <button type="button" onClick={onClose} className="bg-gray-200 dark:bg-gray-600 py-2 px-5 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-700 transition">انصراف</button>
                             <button type="submit" disabled={isLoading} className="bg-indigo-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-indigo-700 transition disabled:bg-indigo-400">{isLoading ? 'در حال ذخیره...' : 'ذخیره تغییرات'}</button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const ManageDemandItemsModal = ({ isOpen, onClose, onSave, demandToEdit, products, defaultStatusId }) => {
            const [items, setItems] = React.useState([]);
            const [originalItemIds, setOriginalItemIds] = React.useState(new Set());
            const [error, setError] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [isEmergency, setIsEmergency] = React.useState(false);

            React.useEffect(() => {
                if (demandToEdit) {
                    const initialItems = demandToEdit.demand_item.map(item => ({ 
                        ...item, 
                        productid: item.product.id, // Ensure productid is set for the select
                        key: crypto.randomUUID() 
                    }));
                    setItems(initialItems);
                    setOriginalItemIds(new Set(initialItems.map(item => item.id)));
                    setIsEmergency(demandToEdit.is_emergency || false);
                }
            }, [demandToEdit]);

            if (!demandToEdit) return null;

            const handleAddItem = () => {
                setItems([...items, { productid: '', quantity: '', demand_admin_note: '', supply_admin_note: '', key: crypto.randomUUID() }]);
            };

            const handleItemChange = (index, field, value) => {
                const newItems = [...items];
                newItems[index][field] = value;
                setItems(newItems);
            };

            const handleRemoveItem = (index) => {
                setItems(items.filter((_, i) => i !== index));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (items.length === 0 || items.some(i => !i.productid || !i.quantity)) {
                    setError('لطفا تمام کالاها را انتخاب کرده و تعداد آنها را مشخص کنید.');
                    return;
                }
                
                setIsLoading(true);
                setError('');

                try {
                    const finalItemIds = new Set(items.filter(i => i.id).map(i => i.id));
                    const itemIdsToDelete = [...originalItemIds].filter(id => !finalItemIds.has(id));
                    
                    if (itemIdsToDelete.length > 0) {
                        await supabaseClient.from('demandstatuslog').delete().in('demand_item_id', itemIdsToDelete);
                        const { error: deleteError } = await supabaseClient.from('demand_item').delete().in('id', itemIdsToDelete);
                        if (deleteError) throw deleteError;
                    }

                    const itemsToAdd = items.filter(item => !item.id);
                    const itemsToUpdate = items.filter(item => item.id && originalItemIds.has(item.id));

                    if (itemsToAdd.length > 0) {
                        const newItemsData = itemsToAdd.map(item => ({
                            demandid: demandToEdit.id,
                            productid: item.productid,
                            quantity: Number(item.quantity),
                            demand_admin_note: item.demand_admin_note,
                            supply_admin_note: item.supply_admin_note,
                            demandstatusid: defaultStatusId
                        }));
                        const { data: insertedItems, error: addError } = await supabaseClient.from('demand_item').insert(newItemsData).select();
                        if (addError) throw addError;

                        const logsToInsert = insertedItems.map(item => ({ demand_item_id: item.id, demandstatusid: defaultStatusId }));
                         if (logsToInsert.length > 0) {
                             const { error: logError } = await supabaseClient.from('demandstatuslog').insert(logsToInsert);
                             if (logError) console.error("Error logging status for new items:", logError);
                         }
                    }
                    
                    if (itemsToUpdate.length > 0) {
                       const updatePromises = itemsToUpdate.map(item => 
                            supabaseClient.from('demand_item').update({
                                quantity: Number(item.quantity),
                                demand_admin_note: item.demand_admin_note,
                                supply_admin_note: item.supply_admin_note,
                                productid: item.productid,
                            }).eq('id', item.id)
                        );
                        const results = await Promise.all(updatePromises);
                        results.forEach(({ error }) => {
                            if (error) throw error;
                        });
                    }

                    if (demandToEdit.is_emergency !== isEmergency) {
                        const { error: demandUpdateError } = await supabaseClient
                            .from('demand')
                            .update({ is_emergency: isEmergency })
                            .eq('id', demandToEdit.id);
                        if (demandUpdateError) throw demandUpdateError;
                    }

                    onSave();
                } catch(err) {
                    console.error("Error managing demand items:", err);
                    setError(`خطا در ذخیره تغییرات: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

             const productOptions = products.map(p => {
                 const telegramCodeProp = p.productproperty?.find(
                     prop => prop.propertykey?.title?.toLowerCase().includes('تلگرام')
                 );
                 const telegramCode = telegramCodeProp ? telegramCodeProp.value : '';
                 const displayTitle = `${telegramCode ? `[${telegramCode}] ` : ''}${p.brand ? p.brand.title + ' ' : ''}${p.title}`;
                 return { id: p.id, title: displayTitle };
            });

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`مدیریت اقلام تقاضای ${demandToEdit.profiles.fullname}`}>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="p-3 bg-gray-100 dark:bg-gray-900 rounded-lg text-sm">
                            <p><span className="font-semibold text-gray-700 dark:text-gray-300">شناسه تقاضا:</span> {demandToEdit.id}</p>
                            <p><span className="font-semibold text-gray-700 dark:text-gray-300">تاریخ ثبت:</span> {formatDateTime(demandToEdit.createdat)}</p>
                        </div>

                        <div className="flex items-center">
                            <input type="checkbox" id="is_emergency_manage_items" checked={isEmergency} onChange={(e) => setIsEmergency(e.target.checked)} className="ml-2 h-4 w-4 rounded text-red-600 border-red-300 focus:ring-red-500" />
                            <label htmlFor="is_emergency_manage_items" className="text-sm font-medium">تقاضای فوری</label>
                        </div>
                        
                        <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
                            <h3 className="text-lg font-semibold mb-2">اقلام درخواستی</h3>
                            <div className="space-y-3">
                                {items.map((item, index) => (
                                    <div key={item.key} className="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-700">
                                        <div className="grid grid-cols-1 md:grid-cols-5 items-end gap-x-4 gap-y-2">
                                            <div className="md:col-span-3">
                                                <label className="text-xs text-gray-500 dark:text-gray-400">محصول</label>
                                                <SearchableSelect options={productOptions} value={item.productid} onChange={(id) => handleItemChange(index, 'productid', id)} placeholder="جستجوی محصول با نام یا کد..." />
                                            </div>
                                            <div className="md:col-span-1">
                                                <label className="text-xs text-gray-500 dark:text-gray-400">تعداد</label>
                                                <input type="number" value={item.quantity} onChange={(e) => handleItemChange(index, 'quantity', e.target.value)} className="w-full bg-white dark:bg-gray-600 p-2 rounded-lg" placeholder="تعداد" min="1" required />
                                            </div>
                                            <div className="flex justify-end"><button type="button" onClick={() => handleRemoveItem(index)} className="text-red-500 hover:text-red-700 p-2">✕</button></div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                            <textarea value={item.demand_admin_note || ''} onChange={(e) => handleItemChange(index, 'demand_admin_note', e.target.value)} placeholder="یادداشت مدیر تقاضا..." className="w-full text-sm bg-white dark:bg-gray-600 p-2 rounded-lg" rows="2"></textarea>
                                            <textarea value={item.supply_admin_note || ''} onChange={(e) => handleItemChange(index, 'supply_admin_note', e.target.value)} placeholder="یادداشت مدیر تامین..." className="w-full text-sm bg-white dark:bg-gray-600 p-2 rounded-lg" rows="2"></textarea>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <button type="button" onClick={handleAddItem} className="mt-4 w-full text-center py-2 px-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition font-semibold">+ افزودن کالا</button>
                        </div>
                        
                        {error && <p className="text-red-500 text-sm">{error}</p>}

                        <div className="flex justify-end gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <button type="button" onClick={onClose} className="bg-gray-200 dark:bg-gray-600 py-2 px-5 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-700 transition">بازگشت</button>
                            <button type="submit" disabled={isLoading} className="bg-indigo-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-indigo-700 transition disabled:bg-indigo-400">{isLoading ? 'در حال ذخیره...' : 'ذخیره تغییرات'}</button>
                        </div>
                    </form>
                </Modal>
            );
        };
        
        // ==================================================
        // Toast Notification System
        // ==================================================
        const ToastContext = React.createContext();

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = React.useState([]);
            const idCounter = React.useRef(0);

            const addToast = React.useCallback((message, type = 'success') => {
                const id = idCounter.current++;
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(toast => toast.id !== id));
                }, 4000);
            }, []);

            const ToastIcon = ({ type }) => {
              if (type === 'success') {
                return <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
              }
              if (type === 'error') {
                 return <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
              }
              return null;
            }

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="fixed bottom-5 left-5 z-[200] space-y-3">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`flex items-center gap-3 p-4 rounded-lg shadow-lg text-white w-64 animate-toast-in ${toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'}`}>
                                <ToastIcon type={toast.type} />
                                <span className="font-semibold">{toast.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        const useToasts = () => React.useContext(ToastContext);


        // ==================================================
        // The Main Application Component
        // ==================================================
        const DemandManagement = ({ theme, toggleTheme }) => {
            const [demands, setDemands] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [isEditItemModalOpen, setIsEditItemModalOpen] = React.useState(false); 
            const [editingItem, setEditingItem] = React.useState(null); 
            const [editingDemand, setEditingDemand] = React.useState(null);
            const [isManageItemsModalOpen, setIsManageItemsModalOpen] = React.useState(false);
            const [demandToManage, setDemandToManage] = React.useState(null);
            
            const [customers, setCustomers] = React.useState([]);
            const [products, setProducts] = React.useState([]);
            const [demandStatuses, setDemandStatuses] = React.useState([]);
            const [defaultStatusId, setDefaultStatusId] = React.useState(null);
            const [confirmState, setConfirmState] = React.useState({ isOpen: false, onConfirm: null, message: '', title: '' });

            const [searchTerm, setSearchTerm] = React.useState('');
            const [statusFilter, setStatusFilter] = React.useState('open'); // Changed default from 'all' to 'open'
            const [emergencyFilter, setEmergencyFilter] = React.useState(false); 
            const [awaitingCustomerFilter, setAwaitingCustomerFilter] = React.useState(false);
            
            const { addToast } = useToasts();

            const fetchAllProducts = async () => {
                let allProducts = [];
                let page = 0;
                let productsLastFetch;
                const pageSize = 1000;

                do {
                    const { data, error } = await supabaseClient
                        .from('product')
                        .select('*, brand(*), productproperty(*, propertykey(*))')
                        .eq('isdeleted', false)
                        .range(page * pageSize, (page + 1) * pageSize - 1);

                    if (error) {
                        console.error("Error fetching products page:", error);
                        throw error;
                    }

                    productsLastFetch = data || [];
                    allProducts = allProducts.concat(productsLastFetch);
                    page++;

                } while (productsLastFetch.length === pageSize);

                return allProducts;
            };

            const fetchData = async () => {
                setIsLoading(true);
                setError('');
                try {
                    const { data: demandData, error: demandError } = await supabaseClient
                        .from('demand')
                        .select(`
                            id, createdat, deadlinedate, is_emergency,
                            profiles (id, fullname, mobile),
                            location (*, city(*, province(*))),
                            demand_item ( id, quantity, approved_supply_price, approved_supply_quantity, demand_admin_note, supply_admin_note, demandstatusid, product ( id, title, brand(*), productproperty(*, propertykey(*)) ), demandstatustype(*) )
                        `)
                        .order('createdat', { ascending: false });
                    if (demandError) throw demandError;
                    
                    const demandsWithCalculatedStatus = demandData.map(d => {
                        let status = 'open';
                        if (d.demand_item.length > 0) {
                            const allItemsAreClosed = d.demand_item.every(
                                item => item.demandstatustype?.main_status === 'Fulfilled' || item.demandstatustype?.main_status === 'Cancelled'
                            );

                            if (allItemsAreClosed) {
                                const hasAtLeastOneFulfilled = d.demand_item.some(
                                    item => item.demandstatustype?.main_status === 'Fulfilled'
                                );

                                if (hasAtLeastOneFulfilled) {
                                    status = 'fulfilled';
                                } else {
                                    status = 'cancelled';
                                }
                            }
                        }

                        const totalValue = d.demand_item.reduce((sum, item) => {
                            const price = item.approved_supply_price || 0;
                            const quantity = item.approved_supply_quantity || 0;
                            return sum + (price * quantity);
                        }, 0);

                        return { ...d, status, totalValue };
                    });
                    setDemands(demandsWithCalculatedStatus || []);

                    const customerRoleRes = await supabaseClient.from('role').select('id').eq('title', 'Customer').single();
                    const customerRoleId = customerRoleRes.data?.id;

                    const [customerRes, productsRes, statusesRes] = await Promise.all([
                        customerRoleId ? supabaseClient.from('profiles').select('id, fullname, mobile').eq('roleid', customerRoleId).eq('isdeleted', false).order('fullname') : Promise.resolve({ data: [] }),
                        fetchAllProducts(),
                        supabaseClient.from('demandstatustype').select('*').order('main_status').order('id')
                    ]);
                    setCustomers(customerRes.data || []);
                    setProducts(productsRes || []);
                    setDemandStatuses(statusesRes.data || []);
                    
                    // Set default status ID for new items
                    const defaultStatus = statusesRes.data?.find(s => s.title_farsi === 'در انتظار تامین');
                    if (defaultStatus) {
                        setDefaultStatusId(defaultStatus.id);
                    } else {
                        console.warn("Default status 'در انتظار تامین' not found. Falling back to first available status.");
                        setDefaultStatusId(statusesRes.data?.[0]?.id || null);
                    }

                } catch (err)
                {
                    console.error("Error fetching demand data:", err);
                    setError(`خطا در بارگذاری اطلاعات: ${err.message}`);
                    addToast('خطا در بارگذاری اطلاعات', 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            React.useEffect(() => { fetchData(); }, []);
            
            const filteredDemands = React.useMemo(() => {
                return demands
                    .filter(demand => {
                        if (!searchTerm) return true;
                        const searchTermLower = searchTerm.toLowerCase();
                        const customerMatch = demand.profiles?.fullname?.toLowerCase().includes(searchTermLower) || demand.profiles?.mobile?.includes(searchTermLower);

                        const productMatch = demand.demand_item.some(item => {
                            if (!item.product) return false;
                            const titleMatch = item.product.title?.toLowerCase().includes(searchTermLower);
                            const brandMatch = item.product.brand?.title?.toLowerCase().includes(searchTermLower);
                            const telegramCodeProp = item.product.productproperty?.find(
                                prop => prop.propertykey?.title?.toLowerCase().includes('تلگرام')
                            );
                            const telegramCode = telegramCodeProp ? telegramCodeProp.value : '';
                            const codeMatch = telegramCode?.toLowerCase().includes(searchTermLower);
                            return titleMatch || brandMatch || codeMatch;
                        });

                        const idMatch = String(demand.id).includes(searchTermLower);
                        return customerMatch || productMatch || idMatch;
                    })
                    .filter(demand => statusFilter === 'all' || demand.status === statusFilter)
                    .filter(demand => !emergencyFilter || demand.is_emergency === true)
                    .filter(demand => 
                        !awaitingCustomerFilter || 
                        demand.demand_item.some(item => item.demandstatustype?.title_farsi === "کالا تامین شد و منتظر تصمیم مشتری هست")
                    );
            }, [demands, searchTerm, statusFilter, emergencyFilter, awaitingCustomerFilter]);

            const handleDeleteDemand = (demandId) => {
                setConfirmState({
                    isOpen: true,
                    title: 'حذف تقاضا',
                    message: `آیا از حذف کامل تقاضا با شناسه ${demandId} و تمام اقلام آن اطمینان دارید؟ این عمل غیرقابل بازگشت است.`,
                    onConfirm: async () => {
                        try {
                            setConfirmState({ isOpen: false });
                            const itemIds = demands.find(d => d.id === demandId)?.demand_item.map(i => i.id) || [];
                            if(itemIds.length > 0) {
                                await supabaseClient.from('demandstatuslog').delete().in('demand_item_id', itemIds);
                                // Optional: Delete demand_item_log entries as well if used
                            }
                            await supabaseClient.from('demand_item').delete().eq('demandid', demandId);
                            await supabaseClient.from('demand').delete().eq('id', demandId);
                            fetchData(); 
                            addToast('تقاضا با موفقیت حذف شد.');
                        } catch (err) {
                            console.error("Error deleting demand:", err);
                            setError(`خطا در حذف تقاضا: ${err.message}`);
                            addToast('خطا در حذف تقاضا', 'error');
                        }
                    }
                });
            };

            const handleOpenModal = () => setIsModalOpen(true);
            const handleCloseModal = () => setIsModalOpen(false);
            const handleSaveDemand = () => { fetchData(); handleCloseModal(); addToast('تقاضای جدید با موفقیت ثبت شد.') };
            
            const handleOpenEditItemModal = (item, demand) => { setEditingItem(item); setEditingDemand(demand); setIsEditItemModalOpen(true); };
            const handleCloseEditItemModal = () => { setEditingItem(null); setEditingDemand(null); setIsEditItemModalOpen(false); };
            const handleSaveItem = () => { fetchData(); handleCloseEditItemModal(); addToast('آیتم با موفقیت به‌روزرسانی شد.'); };

            const handleOpenManageItemsModal = (demand) => { setDemandToManage(demand); setIsManageItemsModalOpen(true); };
            const handleCloseManageItemsModal = () => { setDemandToManage(null); setIsManageItemsModalOpen(false); };
            const handleSaveManagedItems = () => { fetchData(); handleCloseManageItemsModal(); addToast('اقلام تقاضا با موفقیت مدیریت شد.'); };
            
            const groupedStatuses = React.useMemo(() => {
                // Group statuses by their main_status (e.g., Open, Fulfilled, Cancelled)
                return demandStatuses.reduce((acc, status) => {
                    const main = status.main_status;
                    if (!acc[main]) acc[main] = [];
                    acc[main].push(status);
                    return acc;
                }, {});
            }, [demandStatuses]);

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <header className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h1 className="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">مدیریت تقاضاها</h1>
                        <div className="flex items-center gap-4">
                            {/* Theme Toggle Button */}
                            <button onClick={toggleTheme} className="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition" title="تغییر تم">
                                {theme === 'light' ? (
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                                ) : (
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                                )}
                            </button>
                            {/* New Demand Button */}
                            <button onClick={handleOpenModal} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition shadow-md hover:shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" /></svg>
                                <span>ثبت تقاضای جدید</span>
                            </button>
                        </div>
                    </header>
                    
                    <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div className="lg:col-span-2 relative">
                                <label className="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1 block">جستجو</label>
                                <input type="text" placeholder="جستجوی مشتری، محصول یا شناسه..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full p-2 bg-gray-100 dark:bg-gray-700 border border-transparent focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 rounded-lg" />
                                {searchTerm && (
                                    <button onClick={() => setSearchTerm('')} className="absolute left-2 bottom-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /></svg>
                                    </button>
                                )}
                            </div>
                            <div>
                                <label className="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1 block">وضعیت تقاضا</label>
                                <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} className="w-full p-2 bg-gray-100 dark:bg-gray-700 border border-transparent focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 rounded-lg">
                                    <option value="all">همه</option><option value="open">باز</option><option value="fulfilled">تکمیل شده</option><option value="cancelled">لغو شده</option>
                                </select>
                            </div>
                            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-self-start pb-2 gap-x-6 gap-y-2">
                               <div className="flex items-center">
                                    <input type="checkbox" id="emergencyFilter" checked={emergencyFilter} onChange={e => setEmergencyFilter(e.target.checked)} className="ml-2 h-4 w-4 rounded text-indigo-600 border-gray-300 focus:ring-indigo-500" />
                                    <label htmlFor="emergencyFilter" className="text-sm font-medium">فقط فوری‌ها</label>
                                </div>
                                <div className="flex items-center">
                                    <input type="checkbox" id="awaitingCustomerFilter" checked={awaitingCustomerFilter} onChange={e => setAwaitingCustomerFilter(e.target.checked)} className="ml-2 h-4 w-4 rounded text-indigo-600 border-gray-300 focus:ring-indigo-500" />
                                    <label htmlFor="awaitingCustomerFilter" className="text-sm font-medium whitespace-nowrap">کالا تامین شد (منتظر مشتری)</label>
                                </div>
                            </div>
                        </div>
                         <div className="text-xs text-gray-500 dark:text-gray-400 mt-3 border-t border-gray-200 dark:border-gray-700 pt-2">
                            {filteredDemands.length} مورد یافت شد.
                        </div>
                    </div>

                    {isLoading && <div className="spinner"></div>}
                    {error && <p className="text-center text-red-500 bg-red-100 dark:bg-red-900/50 p-4 rounded-lg">{error}</p>}

                    {!isLoading && (
                        <div className="space-y-4">
                        {filteredDemands.map(demand => (
                            <div key={demand.id} className="bg-white dark:bg-gray-800 rounded-lg shadow transition-all hover:shadow-xl border border-gray-100 dark:border-gray-700">
                                <header className="p-3 sm:p-4 border-b border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <h2 className="font-bold text-lg text-indigo-700 dark:text-indigo-400">{demand.profiles.fullname}</h2>
                                            {demand.location?.city?.title && (
                                                <span className="text-sm text-gray-500 dark:text-gray-400">({demand.location.city.title})</span>
                                            )}
                                        </div>
                                        <div className="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-gray-500 dark:text-gray-400 mt-1">
                                            <span>شناسه: <span className="font-mono">{demand.id}</span></span>
                                            <span>تاریخ ثبت: <span className="font-semibold">{formatDateTime(demand.createdat)}</span></span>
                                            {demand.deadlinedate && <span>مهلت تحویل: <span className="font-semibold">{formatDateTime(demand.deadlinedate, false)}</span></span>}
                                            {demand.totalValue > 0 && 
                                                <div className="flex items-center gap-1">
                                                    <span className="font-semibold">ارزش کل تامین:</span>
                                                    <span className="font-semibold font-mono text-green-700 dark:text-green-400">{formatCurrency(demand.totalValue)}</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2 self-end sm:self-center">
                                        {demand.is_emergency && <span className="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 font-semibold" title="فوری">فوری</span>}
                                        <span className={`px-2 py-1 text-xs rounded-full font-semibold ${demand.status === 'fulfilled' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : demand.status === 'cancelled' ? 'bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'}`}>
                                            {demand.status === 'fulfilled' ? 'تکمیل شده' : demand.status === 'cancelled' ? 'لغو شده' : 'باز'}
                                        </span>
                                        <button onClick={() => handleOpenManageItemsModal(demand)} className="text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 p-1 rounded-full transition-colors" title="مدیریت اقلام">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                                <path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" />
                                            </svg>
                                        </button>
                                        <button onClick={() => handleDeleteDemand(demand.id)} className="text-gray-400 hover:text-red-500 dark:hover:text-red-400 p-1 rounded-full transition-colors" title="حذف تقاضا">
                                             <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>
                                        </button>
                                    </div>
                                </header>
                                
                                {/* Demand Items (Desktop Table View - md:block and up) */}
                                <div className="overflow-x-auto hidden md:block">
                                    <table className="min-w-full text-sm text-right divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead className="bg-gray-50 dark:bg-gray-700/50 text-xs text-gray-600 dark:text-gray-300 uppercase">
                                            <tr>
                                                <th className="p-3 text-right">محصول</th>
                                                <th className="p-3 text-right">تعداد درخواستی</th>
                                                <th className="p-3 text-right">قیمت تامین</th>
                                                <th className="p-3 text-right">تعداد تامین</th>
                                                <th className="p-3 text-right">وضعیت آیتم</th>
                                                <th className="p-3 text-right">عملیات</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        {demand.demand_item.map((item, itemIndex) => (
                                            <React.Fragment key={item.id}>
                                                <tr className="hover:bg-gray-50 dark:hover:bg-gray-700/20">
                                                    <td className="p-3 font-semibold text-gray-800 dark:text-gray-100">{item.product ? `${item.product.brand ? item.product.brand.title + ' ' : ''}${item.product.title}`: 'محصول حذف شده'}</td>
                                                    <td className="p-3">{item.quantity}</td>
                                                    <td className="p-3 font-mono">{formatCurrency(item.approved_supply_price)}</td>
                                                    <td className="p-3">{item.approved_supply_quantity || '-'}</td>
                                                    <td className="p-3"><span className="px-2 py-1 text-xs rounded-full whitespace-nowrap" style={{ backgroundColor: item.demandstatustype?.color_bg || '#E5E7EB', color: item.demandstatustype?.color_text || '#1F2937' }}>{item.demandstatustype?.title_farsi || 'ثبت شده'}</span></td>
                                                    <td className="p-3"><button onClick={() => handleOpenEditItemModal(item, demand)} className="text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300 hover:underline text-xs font-semibold">ویرایش</button></td>
                                                </tr>
                                                {(item.demand_admin_note || item.supply_admin_note) && (
                                                    <tr className="bg-gray-50 dark:bg-gray-900/20">
                                                        <td colSpan="6" className="px-4 py-2 text-xs text-gray-600 dark:text-gray-400">
                                                            {item.demand_admin_note && <div><strong>یادداشت مدیر تقاضا:</strong> {item.demand_admin_note}</div>}
                                                            {item.supply_admin_note && <div className="mt-1"><strong>یادداشت مدیر تامین:</strong> {item.supply_admin_note}</div>}
                                                        </td>
                                                    </tr>
                                                )}
                                            </React.Fragment>
                                        ))}
                                        </tbody>
                                    </table>
                                </div>
                                
                                {/* Demand Items (Mobile Card View - default/md:hidden) */}
                                <div className="md:hidden p-3 space-y-3">
                                    {demand.demand_item.map((item, itemIndex) => (
                                        <div key={item.id} className="p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/50 space-y-2">
                                            <div className="flex justify-between items-start border-b pb-2 mb-2 border-gray-200 dark:border-gray-600">
                                                <div className="font-bold text-sm text-indigo-700 dark:text-indigo-400">
                                                    {item.product ? `${item.product.brand ? item.product.brand.title + ' ' : ''}${item.product.title}`: 'محصول حذف شده'}
                                                </div>
                                                <button onClick={() => handleOpenEditItemModal(item, demand)} className="text-indigo-600 dark:text-indigo-400 hover:underline text-xs font-semibold px-2 py-1 rounded-md bg-indigo-100 dark:bg-indigo-900/50">
                                                    ویرایش
                                                </button>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-3 text-xs">
                                                <div className="flex justify-between">
                                                    <span className="text-gray-500 dark:text-gray-400">تعداد درخواستی:</span>
                                                    <span className="font-semibold text-gray-800 dark:text-gray-200">{item.quantity}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-500 dark:text-gray-400">تعداد تامین:</span>
                                                    <span className="font-semibold text-gray-800 dark:text-gray-200">{item.approved_supply_quantity || '-'}</span>
                                                </div>
                                                <div className="flex justify-between col-span-2">
                                                    <span className="text-gray-500 dark:text-gray-400">قیمت تامین:</span>
                                                    <span className="font-mono text-green-600 dark:text-green-400">{formatCurrency(item.approved_supply_price)}</span>
                                                </div>
                                            </div>

                                            <div className="pt-2 border-t border-gray-200 dark:border-gray-600 mt-2">
                                                <div className="text-right mb-2">
                                                    <span className="px-2 py-1 text-xs rounded-full whitespace-nowrap font-medium" style={{ backgroundColor: item.demandstatustype?.color_bg || '#E5E7EB', color: item.demandstatustype?.color_text || '#1F2937' }}>
                                                        {item.demandstatustype?.title_farsi || 'ثبت شده'}
                                                    </span>
                                                </div>
                                                {(item.demand_admin_note || item.supply_admin_note) && (
                                                    <div className="mt-2 text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                        {item.demand_admin_note && <div><strong>مدیر تقاضا:</strong> {item.demand_admin_note}</div>}
                                                        {item.supply_admin_note && <div><strong>مدیر تامین:</strong> {item.supply_admin_note}</div>}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                        </div>
                    )}
                    
                    {!isLoading && filteredDemands.length === 0 && (
                        <div className="text-center py-12">
                            <svg xmlns="http://www.w3.org/2000/svg" className="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <h3 className="mt-2 text-sm font-medium text-gray-900 dark:text-white">هیچ تقاضایی یافت نشد</h3>
                            <p className="mt-1 text-sm text-gray-500">با توجه به فیلترهای اعمال شده، موردی برای نمایش وجود ندارد.</p>
                        </div>
                    )}

                    {isModalOpen && <DemandFormModal isOpen={isModalOpen} onClose={handleCloseModal} onSave={handleSaveDemand} customers={customers} products={products} defaultStatusId={defaultStatusId} />}
                    {isEditItemModalOpen && <EditDemandItemModal isOpen={isEditItemModalOpen} onClose={handleCloseEditItemModal} onSave={handleSaveItem} itemToEdit={editingItem} demand={editingDemand} demandStatuses={demandStatuses} groupedStatuses={groupedStatuses} />}
                    {isManageItemsModalOpen && <ManageDemandItemsModal isOpen={isManageItemsModalOpen} onClose={handleCloseManageItemsModal} onSave={handleSaveManagedItems} demandToEdit={demandToManage} products={products} defaultStatusId={defaultStatusId} />}
                    <ConfirmModal isOpen={confirmState.isOpen} onClose={() => setConfirmState({ isOpen: false, onConfirm: null, message: '', title: '' })} onConfirm={confirmState.onConfirm} title={confirmState.title} message={confirmState.message} />
                </div>
            );
        };
        
        const App = () => {
             const [theme, setTheme] = React.useState('light');
             React.useEffect(() => {
                  // Sync theme state with the document's class for Tailwind
                  document.documentElement.className = theme;
             }, [theme]);

             const toggleTheme = () => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
             };

             return (
                <ToastProvider>
                    <DemandManagement theme={theme} toggleTheme={toggleTheme} />
                </ToastProvider>
             );
         }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>

